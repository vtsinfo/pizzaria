<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .card {
            background-color: #1e293b;
            border: 1px solid #334155;
        }

        .table {
            color: #e2e8f0;
        }

        .table-hover tbody tr:hover {
            color: #fff;
            background-color: #334155;
        }

        .status-pendente {
            color: #fbbf24;
            font-weight: bold;
        }

        .status-confirmada {
            color: #34d399;
            font-weight: bold;
        }

        .status-cancelada {
            color: #f87171;
            text-decoration: line-through;
        }

        .btn-action {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>

    <!-- Navbar Simplificada -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('admin_dashboard') }}">üçï Admin Colonial</a>
            <div class="d-flex">
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-light btn-sm me-2">Voltar</a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìÖ Gest√£o de Reservas</h2>
            <button class="btn btn-primary" onclick="loadReservas()">
                <i class="bi bi-arrow-clockwise"></i> Atualizar
            </button>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Data/Hora</th>
                                <th>Cliente</th>
                                <th>Pessoas</th>
                                <th>Contato</th>
                                <th>Obs</th>
                                <th>Status</th>
                                <th class="text-end">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="reservas-list">
                            <tr>
                                <td colspan="7" class="text-center py-4">Carregando reservas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast de Notifica√ß√£o -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-msg">
                    A√ß√£o realizada com sucesso!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allReservations = [];

        document.addEventListener('DOMContentLoaded', loadReservas);

        function loadReservas() {
            fetch('/api/admin/reservas')
                .then(response => response.json())
                .then(data => {
                    allReservations = data; // A API j√° retorna invertido (mais recente primeiro)
                    renderTable();
                })
                .catch(err => console.error('Erro ao carregar:', err));
        }

        function renderTable() {
            const tbody = document.getElementById('reservas-list');
            tbody.innerHTML = '';

            if (allReservations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Nenhuma reserva encontrada.</td></tr>';
                return;
            }

            allReservations.forEach(res => {
                const tr = document.createElement('tr');

                // Formata√ß√£o de Status
                let statusClass = 'status-pendente';
                let statusIcon = '<i class="bi bi-hourglass-split"></i>';

                if (res.status === 'confirmada') {
                    statusClass = 'status-confirmada';
                    statusIcon = '<i class="bi bi-check-circle-fill"></i>';
                } else if (res.status === 'cancelada') {
                    statusClass = 'status-cancelada';
                    statusIcon = '<i class="bi bi-x-circle-fill"></i>';
                }

                // Link do WhatsApp
                const wppLink = `https://wa.me/55${res.telefone.replace(/\D/g, '')}`;

                tr.innerHTML = `
                    <td>
                        <div class="fw-bold">${res.data_reserva}</div>
                        <small class="text-muted">${res.hora_reserva}</small>
                    </td>
                    <td>${res.nome}</td>
                    <td><span class="badge bg-secondary">${res.pessoas} pessoas</span></td>
                    <td>
                        <a href="${wppLink}" target="_blank" class="text-decoration-none text-info">
                            <i class="bi bi-whatsapp"></i> ${res.telefone}
                        </a>
                    </td>
                    <td><small class="text-muted">${res.obs || '-'}</small></td>
                    <td class="${statusClass}">${statusIcon} ${res.status.toUpperCase()}</td>
                    <td class="text-end">
                        ${res.status === 'pendente' ? `
                            <button class="btn btn-success btn-action me-1" title="Confirmar" onclick="updateStatus(${res.id}, 'confirmada')">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            <button class="btn btn-danger btn-action" title="Cancelar" onclick="updateStatus(${res.id}, 'cancelada')">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        ` : ''}
                        ${res.status !== 'pendente' ? `
                            <button class="btn btn-outline-secondary btn-sm" onclick="updateStatus(${res.id}, 'pendente')">Reabrir</button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStatus(id, newStatus) {
            // Encontra e atualiza localmente
            const index = allReservations.findIndex(r => r.id === id);
            if (index !== -1) {
                allReservations[index].status = newStatus;

                // Envia a lista completa atualizada para o servidor
                // (A API atual espera a lista completa no POST)
                // Nota: Como a lista na tela est√° invertida (recentes primeiro), 
                // mas a API salva o que recebe, vamos garantir que enviamos na ordem correta se necess√°rio.
                // A API app.py l√™ e inverte no GET, mas no POST salva direto.
                // Para evitar bagun√ßa, vamos reverter a invers√£o antes de salvar ou confiar que a ordem de visualiza√ß√£o n√£o afeta o salvamento se mantivermos consistente.
                // O ideal √© enviar a lista como est√° na mem√≥ria (que veio do GET).

                fetch('/api/admin/reservas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allReservations.slice().reverse()) // Reverte para salvar na ordem cronol√≥gica original (antigos primeiro) no arquivo
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            renderTable();
                            const toast = new bootstrap.Toast(document.getElementById('liveToast'));
                            document.getElementById('toast-msg').innerText = `Reserva ${newStatus}!`;
                            toast.show();
                        } else {
                            alert('Erro ao salvar: ' + data.message);
                        }
                    });
            }
        }
    </script>
</body>

</html>