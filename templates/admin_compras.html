{% extends "base_admin.html" %}

{% block title %}Compras â€” Admin Colonial{% endblock %}

{% block content %}
<div class="container admin-container" id="compras-app">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ðŸ›’ HistÃ³rico de Compras</h1>
        <a href="/admin/compras/nova" class="btn btn-warning">
            <i class="fas fa-cart-plus"></i> Nova Compra (Entrada)
        </a>
    </div>

    <div class="card bg-dark text-light border-warning">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Fornecedor</th>
                            <th>Nota Fiscal</th>
                            <th>ObservaÃ§Ã£o</th>
                            <th>Total (R$)</th>
                            <th class="text-end">Detalhes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="c in compras" :key="c.id">
                            <td>[[ c.data ]]</td>
                            <td>[[ c.fornecedor ]]</td>
                            <td>[[ c.nota_fiscal ]]</td>
                            <td><small class="text-muted">[[ c.observacao ]]</small></td>
                            <td class="text-success fw-bold">[[ formatCurrency(c.total) ]]</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-info" @click="showDetails(c)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        <tr v-if="compras.length === 0">
                            <td colspan="6" class="text-center text-muted py-5">
                                <i class="fas fa-receipt fa-2x mb-3"></i><br>
                                Nenhuma compra registrada.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light border-warning">
                <div class="modal-header border-warning">
                    <h5 class="modal-title">Detalhes da Compra #[[ selectedCompra?.id ]]</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" v-if="selectedCompra">
                    <div class="row mb-3">
                        <div class="col-6"><strong>Fornecedor:</strong> [[ selectedCompra.fornecedor ]]</div>
                        <div class="col-6 text-end"><strong>Data:</strong> [[ selectedCompra.data ]]</div>
                    </div>
                    <h6>Itens Comprados</h6>
                    <table class="table table-sm table-dark border-secondary">
                        <thead>
                            <tr class="text-secondary small">
                                <th>Ingrediente</th>
                                <th class="text-end">Qtd</th>
                                <th class="text-end">Custo Unit.</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in selectedCompra.itens">
                                <td>[[ item.ingrediente ]]</td>
                                <td class="text-end">[[ item.qtd ]] [[ item.un ]]</td>
                                <td class="text-end">[[ formatCurrency(item.preco) ]]</td>
                                <td class="text-end">[[ formatCurrency(item.subtotal) ]]</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end fw-bold">TOTAL</td>
                                <td class="text-end fw-bold text-success">[[ formatCurrency(selectedCompra.total) ]]
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                compras: [],
                selectedCompra: null,
                modalInstance: null
            }
        },
        mounted() {
            this.loadCompras();
            const modalEl = document.getElementById('detailsModal');
            if (modalEl) this.modalInstance = new bootstrap.Modal(modalEl);
        },
        methods: {
            formatCurrency(val) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
            },
            loadCompras() {
                fetch('/admin/api/compras')
                    .then(r => r.json())
                    .then(data => this.compras = data);
            },
            showDetails(c) {
                this.selectedCompra = c;
                if (this.modalInstance) this.modalInstance.show();
            }
        }
    }).mount('#compras-app');
</script>
{% endblock %}