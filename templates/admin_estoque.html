{% extends "base_admin.html" %}

{% block title %}Estoque ‚Äî Admin Colonial{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container admin-container" id="stock-app">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üì¶ Gest√£o de Estoque</h1>

        <div>
            <a href="/admin/estoque/baixo" class="btn btn-danger me-2">
                <i class="fas fa-exclamation-triangle"></i> Relat√≥rio Baixo Estoque
            </a>
            <a href="/admin/dashboard" class="btn btn-outline-dark">
                <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
            </a>
        </div>
    </div>

    <!-- Layout Principal -->
    <div class="row">
        <!-- Coluna Esquerda: Lista de Ingredientes (Agora Full Width) -->
        <div class="col-12 mb-4">
            <div class="card bg-dark text-light border-warning h-100">
                <div
                    class="card-header border-warning d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0 text-warning"><i class="fas fa-layer-group"></i> Ingredientes</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-success" @click="triggerImport">
                            <i class="fas fa-file-import"></i> Importar
                        </button>
                        <button class="btn btn-sm btn-info" @click="showSupplierChart">
                            <i class="fas fa-chart-pie"></i> Fornecedores
                        </button>
                        <input type="file" id="importFile" class="d-none" accept=".csv" @change="importCSV">
                        <button class="btn btn-sm btn-success" @click="exportCSV" title="Exportar CSV">
                            <i class="fas fa-file-csv"></i> Exportar
                        </button>
                        <button class="btn btn-sm btn-warning" @click="openModal('new')">
                            <i class="fas fa-plus"></i> Novo Ingrediente
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filtros Responsivos -->
                    <div class="d-flex flex-wrap gap-3 mb-3 align-items-center">
                        <div class="input-group" style="min-width: 250px; flex: 1;">
                            <span class="input-group-text bg-secondary border-secondary text-light"><i
                                    class="fas fa-search"></i></span>
                            <input type="text" class="form-control bg-dark text-light border-secondary"
                                placeholder="Buscar ingrediente..." v-model="search">
                        </div>

                        <select class="form-select bg-dark text-light border-secondary" v-model="filterFornecedor"
                            style="min-width: 200px; flex: 0 1 auto;">
                            <option value="">Todos Fornecedores</option>
                            <option v-for="f in uniqueFornecedores" :value="f">[[ f ]]</option>
                        </select>

                        <div class="form-check form-switch d-flex align-items-center text-nowrap">
                            <input class="form-check-input me-2" type="checkbox" id="filterZero" v-model="filterZero">
                            <label class="form-check-label" for="filterZero">Apenas Zerados</label>
                        </div>
                        <div class="form-check form-switch d-flex align-items-center text-nowrap">
                            <input class="form-check-input me-2" type="checkbox" id="filterBelowMin"
                                v-model="filterBelowMin">
                            <label class="form-check-label text-warning fw-bold" for="filterBelowMin">Abaixo do
                                M√≠nimo</label>
                        </div>
                        <div class="form-check form-switch d-flex align-items-center text-nowrap">
                            <input class="form-check-input me-2" type="checkbox" id="filterValidity"
                                v-model="filterValidity">
                            <label class="form-check-label" for="filterValidity"
                                title="Vencidos ou vencem em 7 dias">Validade Cr√≠tica</label>
                        </div>
                    </div>

                    <div class="ms-auto d-flex align-items-center">
                        <label class="me-2 small text-muted">Por p√°g:</label>
                        <select class="form-select form-select-sm bg-dark text-light border-secondary"
                            v-model.number="itemsPerPage" style="width: 70px;">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 text-nowrap">
                        <thead>
                            <tr>
                                <th @click="sortBy('nome')" class="cursor-pointer">Nome <i
                                        :class="getSortIcon('nome')"></i></th>
                                <th @click="sortBy('tipo')" class="cursor-pointer">Tipo <i
                                        :class="getSortIcon('tipo')"></i></th>
                                <th @click="sortBy('unidade')" class="cursor-pointer">Un <i
                                        :class="getSortIcon('unidade')"></i></th>
                                <th @click="sortBy('estoque_atual')" class="cursor-pointer">Estoque <i
                                        :class="getSortIcon('estoque_atual')"></i></th>
                                <th @click="sortBy('fornecedor')" class="cursor-pointer">Fornecedor <i
                                        :class="getSortIcon('fornecedor')"></i></th>
                                <th @click="sortBy('estoque_minimo')" class="cursor-pointer">M√≠nimo <i
                                        :class="getSortIcon('estoque_minimo')"></i></th>
                                <th @click="sortBy('validade')" class="cursor-pointer">Validade <i
                                        :class="getSortIcon('validade')"></i></th>
                                <th @click="sortBy('custo')" class="cursor-pointer">Custo (R$) <i
                                        :class="getSortIcon('custo')"></i></th>
                                <th @click="sortBy('total')" class="cursor-pointer">Total (R$) <i
                                        :class="getSortIcon('total')"></i></th>
                                <th class="text-end">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="ing in paginatedIngredientes" :key="ing.id"
                                :class="{'table-danger': ing.estoque_atual <= ing.estoque_minimo}">
                                <td>[[ ing.nome ]] <i v-if="ing.estoque_atual <= ing.estoque_minimo"
                                        class="fas fa-exclamation-triangle text-danger"></i></td>
                                <td>
                                    <span :class="getBadgeClass(ing.tipo)">[[ getTipoLabel(ing.tipo) ]]</span>
                                </td>
                                <td>[[ ing.unidade ]]</td>
                                <td>[[ ing.estoque_atual ]]</td>
                                <td><small class="text-muted">[[ ing.fornecedor || '-' ]]</small></td>
                                <td>[[ ing.estoque_minimo ]]</td>
                                <td><small :class="getValidityClass(ing.validade)">[[ formatDate(ing.validade)
                                        ]]</small></td>
                                <td>[[ formatCurrency(ing.custo) ]]</td>
                                <td>[[ formatCurrency(ing.estoque_atual * ing.custo) ]]</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-info me-1" @click="editIngrediente(ing)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning me-1" @click="showHistory(ing)"
                                        title="Hist√≥rico de Custo">
                                        <i class="fas fa-chart-line"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteIngrediente(ing)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="filteredIngredientes.length === 0">
                                <td colspan="10" class="text-center text-muted py-4">Nenhum ingrediente encontrado.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagina√ß√£o -->
                <div class="d-flex justify-content-between align-items-center mt-3" v-if="totalPages > 1">
                    <small class="text-muted">Mostrando [[ (currentPage - 1) * itemsPerPage + 1 ]] - [[
                        Math.min(currentPage * itemsPerPage, filteredIngredientes.length) ]] de [[
                        filteredIngredientes.length ]]</small>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item" :class="{disabled: currentPage === 1}">
                                <button class="page-link bg-dark border-secondary text-light"
                                    @click="currentPage--">Anterior</button>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link bg-dark border-secondary text-light">[[ currentPage ]] / [[
                                    totalPages ]]</span>
                            </li>
                            <li class="page-item" :class="{disabled: currentPage === totalPages}">
                                <button class="page-link bg-dark border-secondary text-light"
                                    @click="currentPage++">Pr√≥xima</button>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Ficha T√©cnica (Agora Abaixo) -->

    <teleport to="body">
        <!-- MODAL INGREDIENTE -->
        <div class="modal fade" id="ingredienteModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content bg-dark text-light border-warning">
                    <div class="modal-header border-warning">
                        <h5 class="modal-title">[[ modalTitle ]]</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-8 mb-3">
                                <label>Nome</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary"
                                    v-model="tempIng.nome">
                            </div>
                            <div class="col-4 mb-3">
                                <label>Tipo</label>
                                <select class="form-select bg-dark text-light border-secondary" v-model="tempIng.tipo">
                                    <option value="insumo">Insumo</option>
                                    <option value="revenda">Revenda</option>
                                    <option value="produto_final">Produto Final</option>
                                    <option value="ambos">Ambos</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label>Fornecedor</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary"
                                    v-model="tempIng.fornecedor" placeholder="Nome do fornecedor">
                            </div>
                            <div class="col-12 mb-3">
                                <label>Validade (Lote Atual)</label>
                                <input type="date" class="form-control bg-dark text-light border-secondary"
                                    v-model="tempIng.validade">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label>Unidade</label>
                                <select class="form-select bg-dark text-light border-secondary"
                                    v-model="tempIng.unidade">
                                    <option value="kg">Quilos (kg)</option>
                                    <option value="g">Gramas (g)</option>
                                    <option value="l">Litros (l)</option>
                                    <option value="ml">Mililitros (ml)</option>
                                    <option value="un">Unidade (un)</option>
                                </select>
                            </div>
                            <div class="col-6 mb-3">
                                <label>Custo Unit√°rio (R$)</label>
                                <input type="number" step="0.01"
                                    class="form-control bg-dark text-light border-secondary" v-model="tempIng.custo">
                            </div>
                            <div class="col-6 mb-3">
                                <label>Estoque Atual</label>
                                <input type="number" step="0.001"
                                    class="form-control bg-dark text-light border-secondary"
                                    v-model="tempIng.estoque_atual">
                            </div>
                            <div class="col-6 mb-3">
                                <label>Estoque M√≠nimo (Alerta)</label>
                                <input type="number" step="0.001"
                                    class="form-control bg-dark text-light border-secondary"
                                    v-model="tempIng.estoque_minimo">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-warning">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-warning" @click="saveIngrediente">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL HIST√ìRICO (GR√ÅFICO) -->
        <div class="modal fade" id="historyModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark text-light border-warning">
                    <div class="modal-header border-warning">
                        <h5 class="modal-title"><i class="fas fa-chart-line text-warning"></i> Hist√≥rico de Custo: [[
                            selectedIngName ]]</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <canvas id="historyChart" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL GR√ÅFICO FORNECEDORES -->
        <div class="modal fade" id="supplierChartModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark text-light border-info">
                    <div class="modal-header border-info">
                        <h5 class="modal-title"><i class="fas fa-chart-pie text-info"></i> Distribui√ß√£o por Fornecedor
                            (Valor R$)</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <canvas id="supplierChartCanvas" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

</div>
</teleport>

</div>
{% endblock %}

{% block scripts %}
<!-- Vue.js 3 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                search: '',
                filterZero: false,
                filterBelowMin: false,
                filterFornecedor: '',
                filterValidity: false,
                sortKey: 'nome',
                sortAsc: true,
                currentPage: 1,
                itemsPerPage: 10,
                ingredientes: [],

                // Modais e Gr√°ficos
                modalTitle: 'Novo Ingrediente',
                modalInstance: null,
                historyModal: null,
                historyChart: null,
                supplierChartModal: null,
                supplierChart: null,
                selectedIngName: '',
                ingredientesError: null,
                tempIng: { id: null, nome: '', unidade: 'kg', tipo: 'insumo', estoque_atual: 0, estoque_minimo: 0, custo: 0, fornecedor: '', validade: '' }
            }
        },
        watch: {
            search() { this.currentPage = 1; },
            filterZero() { this.currentPage = 1; },
            filterFornecedor() { this.currentPage = 1; },
            filterValidity() { this.currentPage = 1; }
        },
        computed: {
            uniqueFornecedores() {
                const s = new Set(this.ingredientes.map(i => i.fornecedor).filter(Boolean));
                return Array.from(s).sort();
            },
            filteredIngredientes() {
                let result = [...this.ingredientes]; // Cria c√≥pia para ordena√ß√£o

                if (this.filterZero) {
                    result = result.filter(i => i.estoque_atual <= 0);
                }

                if (this.filterFornecedor) {
                    result = result.filter(i => i.fornecedor === this.filterFornecedor);
                }

                if (this.filterBelowMin) {
                    result = result.filter(i => i.estoque_atual <= i.estoque_minimo);
                }

                if (this.filterValidity) {
                    const today = new Date();
                    const nextWeek = new Date();
                    nextWeek.setDate(today.getDate() + 7);

                    result = result.filter(i => {
                        if (!i.validade) return false;
                        const v = new Date(i.validade);
                        return v <= nextWeek; // Vencido ou vence em 7 dias
                    });
                }

                if (this.search) {
                    const term = this.search.toLowerCase();
                    result = result.filter(i => i.nome.toLowerCase().includes(term));
                }

                // Ordena√ß√£o
                result.sort((a, b) => {
                    let valA = a[this.sortKey];
                    let valB = b[this.sortKey];

                    // Tratamento especial para coluna calculada Total
                    if (this.sortKey === 'total') {
                        valA = a.estoque_atual * a.custo;
                        valB = b.estoque_atual * b.custo;
                    } else if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }

                    if (valA < valB) return this.sortAsc ? -1 : 1;
                    if (valA > valB) return this.sortAsc ? 1 : -1;
                    return 0;
                });

                return result;
            },
            paginatedIngredientes() {
                const start = (this.currentPage - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                return this.filteredIngredientes.slice(start, end);
            },
            totalPages() {
                return Math.ceil(this.filteredIngredientes.length / this.itemsPerPage);
            }
        },
        mounted() {
            this.loadIngredientes();

            // Inicializa Modal Bootstrap com check de seguran√ßa
            const modalEl = document.getElementById('ingredienteModal');
            const histEl = document.getElementById('historyModal');
            const suppEl = document.getElementById('supplierChartModal');
            if (modalEl && typeof bootstrap !== 'undefined') {
                this.modalInstance = new bootstrap.Modal(modalEl);
                this.historyModal = new bootstrap.Modal(histEl);
                this.supplierChartModal = new bootstrap.Modal(suppEl);
            } else {
                console.error("Bootstrap n√£o carregado ou modal n√£o encontrado");
            }
        },
        methods: {
            formatCurrency(val) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
            },
            getBadgeClass(tipo) {
                const map = {
                    'insumo': 'badge bg-primary',
                    'revenda': 'badge bg-success',
                    'produto_final': 'badge bg-warning text-dark',
                    'ambos': 'badge bg-info text-dark'
                };
                return map[tipo] || 'badge bg-secondary';
            },
            formatDate(dateStr) {
                if (!dateStr) return '-';
                const [y, m, d] = dateStr.split('-');
                return `${d}/${m}/${y}`;
            },
            getValidityClass(dateStr) {
                if (!dateStr) return 'text-muted';
                const today = new Date();
                const valDate = new Date(dateStr);
                const diffTime = valDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays < 0 ? 'text-danger fw-bold' : (diffDays < 7 ? 'text-warning' : 'text-success');
            },
            getTipoLabel(tipo) {
                if (!tipo) return 'Insumo';
                if (tipo === 'produto_final') return 'Produto Final';
                return tipo.charAt(0).toUpperCase() + tipo.slice(1);
            },
            sortBy(key) {
                if (this.sortKey === key) {
                    this.sortAsc = !this.sortAsc;
                } else {
                    this.sortKey = key;
                    this.sortAsc = true;
                }
            },
            getSortIcon(key) {
                if (this.sortKey !== key) return 'fas fa-sort text-muted opacity-25';
                return this.sortAsc ? 'fas fa-sort-up' : 'fas fa-sort-down';
            },
            exportCSV() {
                const items = this.filteredIngredientes;
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Nome;Tipo;Unidade;Estoque Atual;Fornecedor;Estoque Minimo;Custo Unitario;Valor Total\n";

                items.forEach(i => {
                    const total = (i.estoque_atual * i.custo).toFixed(2).replace('.', ',');
                    const custo = i.custo.toFixed(2).replace('.', ',');
                    const estoque = String(i.estoque_atual).replace('.', ',');
                    const minimo = String(i.estoque_minimo).replace('.', ',');
                    const fornecedor = i.fornecedor ? `"${i.fornecedor}"` : '';

                    // Aspas no nome para evitar quebra com ponto e v√≠rgula
                    const row = [`"${i.nome}"`, i.tipo, i.unidade, estoque, fornecedor, minimo, custo, total].join(";");
                    csvContent += row + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "estoque_colonial.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            triggerImport() {
                document.getElementById('importFile').click();
            },
            async importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch('/admin/api/ingredientes/import', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    alert(data.message);
                    if (data.success) this.loadIngredientes();
                } catch (e) {
                    alert('Erro ao importar CSV.');
                }
                event.target.value = ''; // Reset input
            },
            loadIngredientes() {
                fetch('/admin/api/ingredientes')
                    .then(async r => {
                        if (!r.ok) {
                            const err = await r.json().catch(() => ({}));
                            throw new Error(err.error || "Erro na requisi√ß√£o: " + r.status);
                        }
                        return r.json();
                    })
                    .then(data => {
                        if (Array.isArray(data)) {
                            this.ingredientes = data;
                        } else {
                            console.error("Formato inv√°lido:", data);
                            this.ingredientes = [];
                        }
                    })
                    .catch(e => {
                        console.error("Erro ao carregar ingredientes:", e);
                        this.ingredientesError = e.message;
                        alert("Erro ao carregar ingredientes: " + e.message);
                        this.ingredientes = []; // Evita crash no v-for
                    });
            },
            openModal(type) {
                if (type === 'new') {
                    this.modalTitle = 'Novo Ingrediente';
                    this.tempIng = { id: null, nome: '', unidade: 'kg', tipo: 'insumo', estoque_atual: 0, estoque_minimo: 0, custo: 0, fornecedor: '', validade: '' };
                }
                if (this.modalInstance) this.modalInstance.show();
            },
            editIngrediente(ing) {
                this.modalTitle = 'Editar Ingrediente';
                this.tempIng = { ...ing }; // Clone
                if (this.modalInstance) this.modalInstance.show();
            },
            saveIngrediente() {
                fetch('/admin/api/ingredientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.tempIng)
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            this.loadIngredientes();
                            if (this.modalInstance) this.modalInstance.hide();
                        } else {
                            alert("Erro: " + res.message);
                        }
                    });
            },
            deleteIngrediente(ing) {
                if (!confirm(`Excluir ${ing.nome}?`)) return;

                fetch('/admin/api/ingredientes', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: ing.id })
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) this.loadIngredientes();
                        else alert("Erro: " + res.message);
                    });
            },

            // --- HIST√ìRICO E GR√ÅFICO (Chart.js) ---
            async showHistory(ing) {
                this.selectedIngName = ing.nome;
                if (this.historyModal) this.historyModal.show();

                const res = await fetch(`/admin/api/ingrediente/${ing.id}/historico`);
                const data = await res.json();

                const ctx = document.getElementById('historyChart').getContext('2d');

                if (this.historyChart) this.historyChart.destroy();

                this.historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.data),
                        datasets: [{
                            label: 'Custo Unit√°rio (R$)',
                            data: data.map(d => d.custo),
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            },

            // --- FORNECEDORES (Chart.js) ---
            showSupplierChart() {
                if (this.supplierChartModal) this.supplierChartModal.show();

                // Processa Dados: Soma valor total (estoque * custo) por fornecedor
                const groups = {};
                let totalValue = 0;

                this.ingredientes.forEach(i => {
                    const fornecedor = i.fornecedor || 'N√£o Informado';
                    const val = i.estoque_atual * i.custo;
                    if (!groups[fornecedor]) groups[fornecedor] = 0;
                    groups[fornecedor] += val;
                    totalValue += val;
                });

                const labels = Object.keys(groups);
                const data = Object.values(groups);

                // Renderiza Gr√°fico
                this.$nextTick(() => {
                    const ctx = document.getElementById('supplierChartCanvas').getContext('2d');
                    if (this.supplierChart) this.supplierChart.destroy();

                    this.supplierChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: [
                                    '#6610f2', '#6f42c1', '#d63384', '#dc3545',
                                    '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'right', labels: { color: '#fff' } },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.label || '';
                                            if (label) label += ': ';
                                            if (context.parsed !== null) {
                                                label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
            }
        }
    }).mount('#stock-app');
</script>
{% endblock %}
```