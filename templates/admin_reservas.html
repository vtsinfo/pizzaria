{% extends "base_admin.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div id="app" class="container">
    {% raw %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>ðŸ“… GestÃ£o de Reservas</h4>
        <div class="btn-group">
            <button class="btn btn-sm" :class="filter === 'Pendente' ? 'btn-primary' : 'btn-outline-primary'"
                @click="filter = 'Pendente'">Pendentes</button>
            <button class="btn btn-sm" :class="filter === 'Confirmada' ? 'btn-success' : 'btn-outline-success'"
                @click="filter = 'Confirmada'">Confirmadas</button>
            <button class="btn btn-sm" :class="filter === 'all' ? 'btn-secondary' : 'btn-outline-secondary'"
                @click="filter = 'all'">Todas</button>
        </div>
    </div>

    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <div v-else-if="filteredReservas.length === 0" class="alert alert-info text-center">
        Nenhuma reserva encontrada neste filtro.
    </div>

    <div v-else class="row g-3">
        <div v-for="reserva in filteredReservas" :key="reserva.id" class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-start border-4" :class="getStatusBorder(reserva.status)">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">{{ reserva.nome }}</h5>
                        <span class="badge" :class="getStatusBadge(reserva.status)">{{ reserva.status }}</span>
                    </div>

                    <p class="mb-1 text-muted"><i class="fas fa-phone me-2"></i>{{ reserva.telefone }}</p>
                    <p class="mb-1 fs-5 fw-bold"><i class="fas fa-calendar-day me-2 text-primary"></i>{{ reserva.data }}
                        Ã s {{ reserva.hora }}</p>
                    <p class="mb-2"><i class="fas fa-users me-2"></i>{{ reserva.pessoas }} pessoas</p>

                    <div v-if="reserva.obs" class="alert alert-light border p-2 small mb-3">
                        <strong>Obs:</strong> {{ reserva.obs }}
                    </div>

                    <div class="d-flex gap-2 mt-3" v-if="reserva.status === 'Pendente'">
                        <button class="btn btn-success btn-sm flex-grow-1" @click="updateStatus(reserva, 'Confirmada')">
                            <i class="fas fa-check"></i> Confirmar
                        </button>
                        <button class="btn btn-outline-danger btn-sm" @click="updateStatus(reserva, 'Cancelada')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="d-flex gap-2 mt-3" v-if="reserva.status === 'Confirmada'">
                        <button class="btn btn-outline-secondary btn-sm flex-grow-1"
                            @click="updateStatus(reserva, 'Concluida')">
                            <i class="fas fa-flag-checkered"></i> Concluir
                        </button>
                        <button class="btn btn-outline-danger btn-sm" @click="updateStatus(reserva, 'Cancelada')">
                            Cancelar
                        </button>
                    </div>

                    <div class="mt-3 text-center" v-if="reserva.status !== 'Cancelada'">
                        <a :href="'https://wa.me/55' + cleanPhone(reserva.telefone) + '?text=OlÃ¡ ' + reserva.nome + ', sobre sua reserva na Pizzaria Colonial...'"
                            target="_blank" class="btn btn-sm btn-outline-success w-100">
                            <i class="fab fa-whatsapp"></i> Contatar Cliente
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp } = Vue;
    createApp({
        data() {
            return {
                reservas: [],
                loading: true,
                filter: 'Pendente'
            }
        },
        computed: {
            filteredReservas() {
                if (this.filter === 'all') return this.reservas;
                return this.reservas.filter(r => r.status === this.filter);
            }
        },
        mounted() {
            this.fetchReservas();
        },
        methods: {
            async fetchReservas() {
                const res = await fetch('/api/admin/reservas');
                this.reservas = await res.json();
                this.loading = false;
            },
            async updateStatus(reserva, newStatus) {
                if (!confirm(`Mudar status para ${newStatus}?`)) return;

                const res = await fetch('/api/admin/reservas/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: reserva.id, status: newStatus })
                });
                if ((await res.json()).success) {
                    reserva.status = newStatus;
                }
            },
            cleanPhone(phone) {
                return phone.replace(/\D/g, '');
            },
            getStatusBadge(status) {
                const map = { 'Pendente': 'bg-warning text-dark', 'Confirmada': 'bg-success', 'Cancelada': 'bg-danger', 'Concluida': 'bg-secondary' };
                return map[status] || 'bg-secondary';
            },
            getStatusBorder(status) {
                const map = { 'Pendente': 'border-warning', 'Confirmada': 'border-success', 'Cancelada': 'border-danger', 'Concluida': 'border-secondary' };
                return map[status] || 'border-secondary';
            }
        }
    }).mount('#app');
</script>
{% endblock %}