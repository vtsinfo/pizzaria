<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozinha ‚Äî Monitor de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #212529;
            color: #fff !important;
            font-family: sans-serif;
        }

        .text-muted {
            color: #adb5bd !important;
            /* Lighter gray for dark mode */
        }

        .card-pedido {
            background-color: #343a40;
            border: 1px solid #495057;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            font-weight: bold;
            font-size: 1.25rem;
            background-color: #343a40;
            border-bottom: 1px solid #495057;
        }

        .btn-concluir {
            width: 100%;
            font-size: 1.2rem;
            padding: 10px;
        }

        .item-lista {
            font-size: 1.1rem;
            border-bottom: 1px solid #495057;
            padding: 8px 0;
            color: #ecf0f1;
            /* High contrast text */
        }

        .item-lista:last-child {
            border-bottom: none;
        }

        .badge-timer {
            font-size: 0.9rem;
        }

        .new-order-highlight {
            animation: pulse-yellow 2s infinite;
            border: 2px solid #ffc107;
        }

        @keyframes pulse-yellow {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid p-4">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3 border-secondary">
            <h1 class="h2">üßë‚Äçüç≥ Monitor de Cozinha</h1>
            <div class="d-flex align-items-center gap-3">
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
                <span id="last-updated" class="text-white small">Atualizado: --:--:--</span>
                <button id="btn-enable-sound" class="btn btn-outline-warning btn-sm">
                    üîá Ativar Som
                </button>
            </div>
        </div>

        <div id="orders-container" class="row">
            <div class="col-12 text-center mt-5">
                <div class="spinner-border text-warning" role="status"></div>
                <p class="mt-2 text-muted">Carregando pedidos...</p>
            </div>
        </div>
    </div>

    <!-- Som de Alerta (Sino de Cozinha) -->
    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        preload="auto"></audio>

    <script>
        let currentOrders = [];
        let knownOrderIds = [];
        let audioEnabled = false;
        const sound = document.getElementById('alert-sound');
        const btnSound = document.getElementById('btn-enable-sound');
        const container = document.getElementById('orders-container');

        // Configura√ß√£o do Som (Browser Policy exige intera√ß√£o do usu√°rio)
        btnSound.addEventListener('click', () => {
            audioEnabled = !audioEnabled;
            if (audioEnabled) {
                btnSound.innerHTML = "üîä Som Ativado";
                btnSound.classList.replace('btn-outline-warning', 'btn-success');
                // Toca brevemente para desbloquear o √°udio no navegador
                sound.volume = 1.0;
                sound.play().then(() => {
                    setTimeout(() => { sound.pause(); sound.currentTime = 0; }, 500);
                }).catch(e => console.warn("Erro ao iniciar √°udio:", e));
            } else {
                btnSound.innerHTML = "üîá Ativar Som";
                btnSound.classList.replace('btn-success', 'btn-outline-warning');
            }
        });

        function fetchOrders() {
            fetch('/api/admin/pedidos')
                .then(r => r.json())
                .then(data => {
                    currentOrders = data;
                    updateInterface(data);
                    document.getElementById('last-updated').innerText = 'Atualizado: ' + new Date().toLocaleTimeString();
                })
                .catch(e => console.error("Erro de conex√£o:", e));
        }

        function updateInterface(orders) {
            const currentIds = orders.map(o => o.id);

            // Verifica novos pedidos para tocar som
            if (knownOrderIds.length > 0) {
                const newOrders = currentIds.filter(id => !knownOrderIds.includes(id));
                if (newOrders.length > 0 && audioEnabled) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.error("Autoplay bloqueado:", e));
                }
            }
            knownOrderIds = currentIds;

            // Renderiza√ß√£o
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center text-muted mt-5">
                        <h3 class="opacity-50">Nenhum pedido pendente ‚úÖ</h3>
                        <p>Aguardando novos pedidos...</p>
                    </div>`;
                return;
            }

            let html = '';
            orders.forEach(order => {
                // Itens
                let itemsHtml = order.items.map(item =>
                    `<div class="item-lista d-flex justify-content-between">
                        <span><strong>${item.quantity}x</strong> ${item.name}</span>
                     </div>`
                ).join('');

                // Badge de Tempo
                const timeParts = order.timestamp.split(' ')[1].split(':');
                const timeStr = `${timeParts[0]}:${timeParts[1]}`;

                html += `
                    <div class="col-md-6 col-lg-4 col-xl-3">
                        <div class="card card-pedido">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>#${order.id} <small class="fw-normal text-white-50">${order.customer.split(' ')[0]}</small></span>
                                <span class="badge bg-dark border border-secondary badge-timer">üïí ${timeStr}</span>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    ${itemsHtml}
                                </div>
                                ${order.obs ? `<div class="alert alert-warning p-2 mb-2"><small>üìù ${order.obs}</small></div>` : ''}
                                <div class="text-center mb-3">
                                    <span class="badge ${order.method === 'Entrega' ? 'bg-info text-dark' : 'bg-secondary'}">${order.method}</span>
                                </div>
                                <button onclick="imprimirPedido(${order.id})" class="btn btn-outline-light w-100 mb-2">
                                    üñ®Ô∏è Imprimir
                                </button>
                                <button onclick="concluirPedido(${order.id})" class="btn btn-success btn-concluir">
                                    ‚úÖ Pronto
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function concluirPedido(id) {
            if (!confirm('Confirmar que o pedido #' + id + ' est√° pronto?')) return;

            fetch('/api/admin/pedido/concluir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            })
                .then(r => r.json())
                .then(res => {
                    if (res.success) fetchOrders();
                    else alert('Erro ao concluir pedido.');
                });
        }

        function imprimirPedido(id) {
            const order = currentOrders.find(o => o.id === id);
            if (!order) return;

            const itemsHtml = order.items.map(item =>
                `<div>${item.quantity}x ${item.name}</div>`
            ).join('');

            const html = `
                <html>
                <head>
                    <title>Pedido #${order.id}</title>
                    <style>
                        body { font-family: monospace; width: 300px; font-size: 14px; margin: 0; padding: 10px; }
                        .header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
                        .items { border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
                        .obs { font-weight: bold; margin-top: 10px; font-size: 16px; }
                        @media print { .no-print { display: none; } }
                        .btn-close { margin-top: 15px; width: 100%; padding: 10px; background: #333; color: white; border: none; cursor: pointer; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>PEDIDO #${order.id}</h2>
                        <p>${order.customer}<br>${order.timestamp}</p>
                        <p><strong>${order.method}</strong></p>
                    </div>
                    <div class="items">${itemsHtml}</div>
                    ${order.obs ? `<div class="obs">OBS: ${order.obs}</div>` : ''}
                    <button class="no-print btn-close" onclick="window.close()">Fechar Janela</button>
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>`;

            const win = window.open('', '_blank', 'width=350,height=600');
            win.document.write(html);
            win.document.close();
        }

        // Polling a cada 10 segundos
        setInterval(fetchOrders, 10000);
        fetchOrders();
    </script>
</body>

</html>