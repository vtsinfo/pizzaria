<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .admin-header {
            background: #343a40;
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }
    </style>
</head>

<body>

    <nav class="admin-header">
        <div class="container d-flex justify-content-between align-items-center">
            <h3 class="m-0">üçï Admin Colonial</h3>
            <div>
                <a href="/admin/dashboard" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
                <a href="/admin" class="btn btn-outline-light btn-sm me-2">Card√°pio</a>
                <a href="/admin/pedidos" class="btn btn-outline-light btn-sm me-2">Pedidos</a>
                <a href="/admin/motoboys" class="btn btn-outline-light btn-sm me-2">Motoboys</a>
                <a href="/admin/cupons" class="btn btn-light btn-sm me-2 fw-bold">Cupons</a>
                <a href="/admin/promocoes" class="btn btn-outline-light btn-sm me-2">Promo√ß√µes</a>
                <a href="/logout" class="btn btn-danger btn-sm">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <!-- Formul√°rio de Adi√ß√£o -->
            <div class="col-md-4 mb-4">
                <div class="card p-4">
                    <h5 class="mb-3">Novo Cupom</h5>
                    <form id="addCouponForm">
                        <div class="mb-3">
                            <label class="form-label">C√≥digo (Ex: PIZZA10)</label>
                            <input type="text" class="form-control" id="code" required
                                style="text-transform: uppercase;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Desconto</label>
                            <select class="form-select" id="type">
                                <option value="porcentagem">Porcentagem (%)</option>
                                <option value="fixo">Valor Fixo (R$)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor</label>
                            <input type="number" class="form-control" id="value" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o</label>
                            <input type="text" class="form-control" id="desc" placeholder="Ex: 10% de desconto">
                        </div>
                        <button type="submit" class="btn btn-success w-100">Adicionar Cupom</button>
                    </form>
                </div>
            </div>

            <!-- Lista de Cupons -->
            <div class="col-md-8">
                <div class="card p-4">
                    <h5 class="mb-3">Cupons Ativos</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Desconto</th>
                                    <th>Descri√ß√£o</th>
                                    <th class="text-end">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="couponsTable">
                                <!-- Preenchido via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let coupons = {};

        async function loadCoupons() {
            const res = await fetch('/api/admin/cupons');
            coupons = await res.json();
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('couponsTable');
            tbody.innerHTML = '';

            for (const [code, data] of Object.entries(coupons)) {
                const valueDisplay = data.tipo === 'porcentagem' ? `${data.valor}%` : `R$ ${parseFloat(data.valor).toFixed(2)}`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="badge bg-primary fs-6">${code}</span></td>
                    <td><strong>${valueDisplay}</strong> <small class="text-muted">(${data.tipo})</small></td>
                    <td>${data.desc}</td>
                    <td class="text-end">
                        <button onclick="deleteCoupon('${code}')" class="btn btn-outline-danger btn-sm">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        document.getElementById('addCouponForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('code').value.toUpperCase().trim();
            const type = document.getElementById('type').value;
            const value = parseFloat(document.getElementById('value').value);
            const desc = document.getElementById('desc').value;

            if (!code || !value) return;

            coupons[code] = { valor: value, tipo: type, desc: desc };
            await saveCoupons();

            e.target.reset();
            renderTable();
        });

        async function deleteCoupon(code) {
            if (confirm(`Deseja realmente excluir o cupom ${code}?`)) {
                delete coupons[code];
                await saveCoupons();
                renderTable();
            }
        }

        async function saveCoupons() {
            await fetch('/api/admin/cupons/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(coupons)
            });
        }

        loadCoupons();
    </script>
</body>

</html>