{% extends "base_admin.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="m-0"><i class="fas fa-exclamation-triangle text-danger"></i> Relatório de Baixo Estoque</h4>
        <a href="/admin/estoque" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Voltar para Estoque
        </a>
    </div>

    <div class="card shadow-sm border-danger">
        <div class="card-header bg-danger text-white fw-bold">
            Itens Críticos (Abaixo do Mínimo)
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Item</th>
                            <th>Tipo</th>
                            <th class="text-center">Estoque Atual</th>
                            <th class="text-center">Mínimo</th>
                            <th class="text-center">Status</th>
                            <th class="text-end">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td colspan="6" class="text-center py-4">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', loadData);

    async function loadData() {
        try {
            const response = await fetch('/api/admin/estoque/baixo');
            const data = await response.json();
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-success"><i class="fas fa-check-circle me-2"></i> Tudo certo! Nenhum item com estoque baixo.</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');

                // Define status visual
                let statusBadge = '';
                if (item.estoque_atual <= 0) {
                    statusBadge = '<span class="badge bg-dark">Zerado</span>';
                    row.classList.add('table-danger'); // Destaca linha inteira se zerado
                } else {
                    statusBadge = '<span class="badge bg-danger">Baixo</span>';
                }

                row.innerHTML = `
                    <td class="fw-bold">${item.nome}</td>
                    <td><span class="badge bg-secondary">${item.tipo}</span></td>
                    <td class="text-center fs-5 fw-bold">${item.estoque_atual} <small class="fs-6 fw-normal text-muted">${item.unidade}</small></td>
                    <td class="text-center">${item.estoque_minimo} <small class="text-muted">${item.unidade}</small></td>
                    <td class="text-center">${statusBadge}</td>
                    <td class="text-end">
                        <a href="/admin/estoque" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i> Ajustar</a>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Erro:', error);
            document.getElementById('table-body').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados.</td></tr>';
        }
    }
</script>
{% endblock %}